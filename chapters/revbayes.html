<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Apuntes sobre RevBayes – Patrones filogenéticos: macroevolución y adaptación</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/u1_intro_diversification.html" rel="next">
<link href="../chapters/Rstudio.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-c6cbc1d6fb8db58f958c455fce091558.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles/custom.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/revbayes.html"><span class="chapter-title">Apuntes sobre RevBayes</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Patrones filogenéticos: macroevolución y adaptación</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Inicio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/install.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Instalación de Software</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/commandline.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Apuntes sobre comandos básicos en Bash</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/Rstudio.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Apuntes sobre R y Rstudio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/revbayes.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Apuntes sobre RevBayes</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Unidad 1: Patrones de diversificación</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/u1_intro_diversification.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Introducción al proceso de diversificación</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/u1_intro_diversification_2.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Modelos con cambios en las Tasas de Especiación</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#introducción-a-la-inferencia-bayesiana" id="toc-introducción-a-la-inferencia-bayesiana" class="nav-link active" data-scroll-target="#introducción-a-la-inferencia-bayesiana">Introducción a la Inferencia Bayesiana</a></li>
  <li><a href="#diferencia-entre-inferencia-bayesiana-y-máxima-verosimilitud" id="toc-diferencia-entre-inferencia-bayesiana-y-máxima-verosimilitud" class="nav-link" data-scroll-target="#diferencia-entre-inferencia-bayesiana-y-máxima-verosimilitud">Diferencia entre Inferencia Bayesiana y Máxima Verosimilitud</a></li>
  <li><a href="#qué-es-revbayes" id="toc-qué-es-revbayes" class="nav-link" data-scroll-target="#qué-es-revbayes">¿Qué es RevBayes?</a></li>
  <li><a href="#qué-es-el-muestreo-mcmc" id="toc-qué-es-el-muestreo-mcmc" class="nav-link" data-scroll-target="#qué-es-el-muestreo-mcmc">¿Qué es el Muestreo MCMC?</a>
  <ul class="collapse">
  <li><a href="#por-qué-se-necesita-mcmc" id="toc-por-qué-se-necesita-mcmc" class="nav-link" data-scroll-target="#por-qué-se-necesita-mcmc">¿Por qué se necesita MCMC?</a></li>
  <li><a href="#cómo-funciona-mcmc" id="toc-cómo-funciona-mcmc" class="nav-link" data-scroll-target="#cómo-funciona-mcmc">¿Cómo funciona MCMC?</a></li>
  <li><a href="#métodos-populares-de-mcmc" id="toc-métodos-populares-de-mcmc" class="nav-link" data-scroll-target="#métodos-populares-de-mcmc">Métodos populares de MCMC</a></li>
  <li><a href="#cómo-saber-si-una-cadena-ha-convergido" id="toc-cómo-saber-si-una-cadena-ha-convergido" class="nav-link" data-scroll-target="#cómo-saber-si-una-cadena-ha-convergido">¿Cómo saber si una cadena ha convergido?</a></li>
  </ul></li>
  <li><a href="#modelos-gráficos-en-revbayes" id="toc-modelos-gráficos-en-revbayes" class="nav-link" data-scroll-target="#modelos-gráficos-en-revbayes">Modelos Gráficos en RevBayes</a>
  <ul class="collapse">
  <li><a href="#tipos-de-nodos-en-revbayes" id="toc-tipos-de-nodos-en-revbayes" class="nav-link" data-scroll-target="#tipos-de-nodos-en-revbayes">Tipos de Nodos en RevBayes</a></li>
  </ul></li>
  <li><a href="#comparación-entre-revbayes-y-r" id="toc-comparación-entre-revbayes-y-r" class="nav-link" data-scroll-target="#comparación-entre-revbayes-y-r">Comparación entre RevBayes y R</a></li>
  <li><a href="#ejemplo-micheladas-en-tepito" id="toc-ejemplo-micheladas-en-tepito" class="nav-link" data-scroll-target="#ejemplo-micheladas-en-tepito">📊 Ejemplo Micheladas en Tepito</a>
  <ul class="collapse">
  <li><a href="#definiendo-el-modelo-en-revbayes" id="toc-definiendo-el-modelo-en-revbayes" class="nav-link" data-scroll-target="#definiendo-el-modelo-en-revbayes">🔹 1. Definiendo el Modelo en RevBayes</a></li>
  <li><a href="#código-en-revbayes" id="toc-código-en-revbayes" class="nav-link" data-scroll-target="#código-en-revbayes">🔹 2. Código en RevBayes</a></li>
  <li><a href="#mini-ejercicio" id="toc-mini-ejercicio" class="nav-link" data-scroll-target="#mini-ejercicio">Mini-ejercicio</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">Apuntes sobre RevBayes</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introducción-a-la-inferencia-bayesiana" class="level1">
<h1>Introducción a la Inferencia Bayesiana</h1>
<p>La <strong>inferencia bayesiana</strong> es un enfoque de la estadística que permite actualizar nuestras creencias sobre un parámetro desconocido <strong>a medida que obtenemos nueva información</strong>. Se basa en el <strong>Teorema de Bayes</strong>, que nos dice cómo combinar la información previa con la evidencia observada.</p>
<p>El <strong>Teorema de Bayes</strong> se expresa matemáticamente como:</p>
<p><span class="math display">\[
P(\theta | D) = \frac{P(D | \theta) P(\theta)}{P(D)}
\]</span></p>
<ul>
<li><p>Donde: <span class="math inline">\(P(\theta | D)\)</span> es la <strong>probabilidad posterior</strong> del parámetro <span class="math inline">\(\theta\)</span> después de observar los datos <span class="math inline">\(D\)</span></p></li>
<li><p><span class="math inline">\(P(D | \theta)\)</span> es la <strong>verosimilitud</strong>, la probabilidad de los datos <span class="math inline">\(D\)</span> dados un valor del parámetro <span class="math inline">\(\theta\)</span>.</p></li>
<li><p><span class="math inline">\(P(\theta)\)</span> es la <strong>distribución prior</strong>, que refleja nuestra creencia sobre <span class="math inline">\(\theta\)</span> antes de observar los datos</p></li>
<li><p><span class="math inline">\(P(D)\)</span> es la <strong>evidencia</strong>, un factor de normalización que garantiza que la probabilidad total sea 1.</p></li>
</ul>
<p>El <strong>objetivo de la inferencia bayesiana</strong> es calcular la <strong>distribución posterior</strong>, que nos proporciona una estimación más precisa del parámetro <span class="math inline">\(\theta\)</span> al incorporar tanto datos como conocimiento previo.</p>
</section>
<section id="diferencia-entre-inferencia-bayesiana-y-máxima-verosimilitud" class="level1">
<h1>Diferencia entre Inferencia Bayesiana y Máxima Verosimilitud</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 39%">
<col style="width: 41%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Enfoque</strong></th>
<th><strong>Máxima Verosimilitud (MV)</strong></th>
<th><strong>Inferencia Bayesiana</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Pregunta clave</strong></td>
<td>¿Cuál es el valor de <span class="math inline">\(\theta\)</span> que maximiza la probabilidad de los datos?</td>
<td>¿Cómo cambia nuestra creencia sobre <span class="math inline">\(\theta\)</span> después de observar los datos?</td>
</tr>
<tr class="even">
<td><strong>Ecuación base</strong></td>
<td><span class="math display">\[ \hat{\theta} = \arg\max_{\theta} P(D | \theta) \]</span></td>
<td><span class="math display">\[ P(\theta | D) \propto P(D | \theta) P(\theta) \]</span></td>
</tr>
<tr class="odd">
<td><strong>Uso de información previa?</strong></td>
<td>❌ No</td>
<td>✅ Sí (usa una distribución prior)</td>
</tr>
<tr class="even">
<td><strong>Resultado</strong></td>
<td>Un solo valor óptimo para <span class="math inline">\(\theta\)</span></td>
<td>Una distribución completa sobre <span class="math inline">\(\theta\)</span></td>
</tr>
<tr class="odd">
<td><strong>Estimación de incertidumbre?</strong></td>
<td>❌ No la estima</td>
<td>✅ Sí, con la distribución posterior</td>
</tr>
<tr class="even">
<td><strong>Flexibilidad con nuevos datos?</strong></td>
<td>❌ No se actualiza fácilmente</td>
<td>✅ Se actualiza dinámicamente con más datos</td>
</tr>
</tbody>
</table>
</section>
<section id="qué-es-revbayes" class="level1">
<h1>¿Qué es RevBayes?</h1>
<p>A diferencia de otros programas, <strong>RevBayes</strong> se basa en un <strong>lenguaje declarativo y probabilístico</strong>, lo que permite definir modelos gráficos y realizar inferencia mediante <strong>Markov Chain Monte Carlo (MCMC)</strong>.</p>
<p><strong>Principales características de RevBayes:</strong></p>
<ul>
<li><p>Utiliza <strong>modelos gráficos probabilísticos</strong>.</p></li>
<li><p>Tiene una sintaxis similar a <strong>R</strong>, pero con mayor enfoque en la inferencia bayesiana.</p></li>
<li><p>Permite definir relaciones entre variables mediante <strong>nodos</strong>.</p></li>
<li><p>Utiliza <strong>muestreo MCMC</strong> para estimar distribuciones posteriores.</p></li>
</ul>
</section>
<section id="qué-es-el-muestreo-mcmc" class="level1">
<h1>¿Qué es el Muestreo MCMC?</h1>
<p>El <strong>Muestreo MCMC (Markov Chain Monte Carlo)</strong> es un conjunto de métodos computacionales utilizados para <strong>aproximar distribuciones de probabilidad complejas</strong>, especialmente en <strong>inferencia bayesiana</strong> y problemas donde el espacio de parámetros es muy grande.</p>
<section id="por-qué-se-necesita-mcmc" class="level2">
<h2 class="anchored" data-anchor-id="por-qué-se-necesita-mcmc">¿Por qué se necesita MCMC?</h2>
<p>En inferencia bayesiana, la distribución posterior de un parámetro <span class="math inline">\(\theta\)</span> se calcula usando:</p>
<p><span class="math display">\[
P(\theta | D) = \frac{P(D | \theta) P(\theta)}{P(D)}
\]</span></p>
<p>Pero en la práctica, el denominador <span class="math inline">\(P(D)\)</span> es difícil de calcular, ya que requiere integrar sobre todos los valores posibles de <span class="math inline">\(\theta\)</span>:</p>
<p><span class="math display">\[
P(D) = \int P(D | \theta) P(\theta) d\theta
\]</span></p>
<p>Cuando el espacio de parámetros es muy grande, esta integral es imposible de resolver analíticamente. MCMC nos ayuda a aproximar la distribución posterior sin necesidad de calcular <span class="math inline">\(P(D)\)</span>.</p>
</section>
<section id="cómo-funciona-mcmc" class="level2">
<h2 class="anchored" data-anchor-id="cómo-funciona-mcmc">¿Cómo funciona MCMC?</h2>
<p>MCMC <strong>simula valores</strong> de los parámetros siguiendo estos pasos:</p>
<ol type="1">
<li><p><strong>Empieza en un valor inicial</strong> .</p></li>
<li><p><strong>Propone un nuevo valor</strong> basado en una distribución de transición.</p></li>
<li><p><strong>Decide si acepta o rechaza</strong> según la regla de aceptación.</p></li>
<li><p><strong>Repite el proceso muchas veces</strong> para construir una cadena de valores que sigan la distribución posterior.</p></li>
</ol>
<p>🔹 <strong>Importante:</strong><br>
Con suficientes iteraciones, la cadena <strong>converge</strong> a la distribución posterior, permitiendo estimar parámetros de manera precisa.</p>
</section>
<section id="métodos-populares-de-mcmc" class="level2">
<h2 class="anchored" data-anchor-id="métodos-populares-de-mcmc">Métodos populares de MCMC</h2>
<p>Existen varias formas de implementar MCMC. Las más comunes son:</p>
<p>✅ <strong>1. Algoritmo de Metropolis-Hastings</strong></p>
<ul>
<li><p>Propone un nuevo valor <span class="math inline">\(\theta^*\)</span>.</p></li>
<li><p>Decide si lo acepta o no comparando la razón de aceptación:</p>
<p><span class="math display">\[
r = \frac{P(D | \theta^*) P(\theta^*)}{P(D | \theta) P(\theta)}
\]</span></p>
<ul>
<li>Si <span class="math inline">\(r \geq 1\)</span>, acepta <span class="math inline">\(\theta^*\)</span>.</li>
<li>Si <span class="math inline">\(r &lt; 1\)</span>, acepta <span class="math inline">\(\theta^*\)</span> con probabilidad <span class="math inline">\(r\)</span>.</li>
</ul></li>
</ul>
<p>Se usa cuando no se conoce la forma exacta de la distribución posterior.</p>
</section>
<section id="cómo-saber-si-una-cadena-ha-convergido" class="level2">
<h2 class="anchored" data-anchor-id="cómo-saber-si-una-cadena-ha-convergido">¿Cómo saber si una cadena ha convergido?</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/rebvayes/53482247_2120318871350183_7589131882600595456_n.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="350"></p>
</figure>
</div>
<p>Algunas técnicas comunes para evaluar la convergencia incluyen:</p>
<ul>
<li><p><strong>Inspección visual de trazas</strong>: un gráfico de trazas muestra si la cadena ha alcanzado un comportamiento estable sin tendencias obvias.</p></li>
<li><p><strong>Tamaño de muestra efectivo (Effective Sample Size, ESS)</strong>: Dado que las muestras en MCMC están correlacionadas, el número real de muestras independientes es menor que el número total de iteraciones. El tamaño de muestra efectivo (ESS) estima cuántas muestras independientes equivalentes hay en la cadena.</p></li>
</ul>
<p>Se calcula como:</p>
<p><span class="math display">\[
ESS = \frac{N}{1 + 2 \sum \rho_k}
\]</span></p>
<p>Donde <span class="math inline">\(N\)</span> es el número total de iteraciones y <span class="math inline">\(\rho_k\)</span> es la autocorrelación en el retraso <span class="math inline">\(k\)</span>. <strong>Un ESS alto (</strong><span class="math inline">\(ESS &gt; 200\)</span>) indica que la cadena ha explorado bien el espacio de parámetros y proporciona estimaciones confiables.</p>
<p>Un ESS bajo sugiere que las muestras están altamente correlacionadas y que se necesitan más iteraciones o una mejor parametrización del algoritmo para obtener estimaciones más precisas.</p>
<p>Para visualizar estos valores y generar gráficos, se puede utilizar <strong>Tracer</strong>, una herramienta que facilita el análisis de convergencia de cadenas MCMC. Se puede descargar en el siguiente enlace:</p>
<p><a href="https://github.com/beast-dev/tracer/releases/tag/v1.7.2">Tracer v1.7.2</a></p>
</section>
</section>
<section id="modelos-gráficos-en-revbayes" class="level1">
<h1>Modelos Gráficos en RevBayes</h1>
<p>En RevBayes, un <strong>modelo gráfico</strong> representa la relación entre variables aleatorias en un modelo bayesiano. Cada variable en el modelo es representada por un <strong>nodo</strong>, y las relaciones entre ellas se representan como <strong>bordes en un grafo</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/rebvayes/graphical_model_legend.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="450"></p>
</figure>
</div>
<section id="tipos-de-nodos-en-revbayes" class="level2">
<h2 class="anchored" data-anchor-id="tipos-de-nodos-en-revbayes">Tipos de Nodos en RevBayes</h2>
<section id="nodos-constantes" class="level3">
<h3 class="anchored" data-anchor-id="nodos-constantes">👉 <strong>Nodos Constantes</strong></h3>
<p>Son valores fijos dentro del modelo. No tienen incertidumbre.</p>
<pre><code>n = 10  # Número de observaciones</code></pre>
</section>
<section id="nodos-estocásticos" class="level3">
<h3 class="anchored" data-anchor-id="nodos-estocásticos">👉 <strong>Nodos Estocásticos</strong></h3>
<p>Representan <strong>variables aleatorias</strong> con una distribución. Son los parámetros del modelo.</p>
<pre><code>theta ~ dnBeta(2,2)  # Prior Beta(2,2)</code></pre>
<p>En este caso, <code>theta</code> es una variable aleatoria con una distribución Beta.</p>
</section>
<section id="nodos-deterministas" class="level3">
<h3 class="anchored" data-anchor-id="nodos-deterministas">👉 <strong>Nodos Deterministas</strong></h3>
<p>Son <strong>valores calculados</strong> a partir de otros nodos.</p>
<pre><code>mu := theta * n  # Media esperada</code></pre>
<p>Aquí, <code>mu</code> se calcula a partir de <code>theta</code> y <code>n</code>.</p>
</section>
<section id="nodos-clamped-observados" class="level3">
<h3 class="anchored" data-anchor-id="nodos-clamped-observados">👉 <strong>Nodos Clamped (Observados)</strong></h3>
<p>Se utilizan para fijar valores observados en el modelo.</p>
<pre><code>D ~ dnBinomial(n, theta)  # Modelo Binomial
D.clamp(7)  # Observamos 7 éxitos</code></pre>
<p>En este caso, <code>D</code> es una variable aleatoria Binomial, pero la fijamos en <code>7</code>.</p>
</section>
<section id="nodos-plate" class="level3">
<h3 class="anchored" data-anchor-id="nodos-plate">👉 <strong>Nodos Plate</strong></h3>
<p>Los <strong>plates</strong> se usan para <strong>repetir estructuras</strong> en modelos jerárquicos.</p>
<pre><code>for (i in 1:10) {
    theta[i] ~ dnBeta(2,2)
}</code></pre>
<p>Aquí, estamos creando <strong>10 valores de <code>theta</code></strong>, cada uno con una distribución Beta(2,2).</p>
</section>
</section>
</section>
<section id="comparación-entre-revbayes-y-r" class="level1">
<h1>Comparación entre RevBayes y R</h1>
<p>RevBayes tiene una sintaxis similar a <strong>R</strong>, pero existen diferencias clave:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 42%">
<col style="width: 30%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Característica</strong></td>
<td><strong>RevBayes</strong></td>
<td><strong>R</strong></td>
</tr>
<tr class="even">
<td><strong>Declaración de variables</strong></td>
<td><code>theta ~ dnBeta(2,2)</code></td>
<td><code>theta &lt;- rbeta(1, 2, 2)</code></td>
</tr>
<tr class="odd">
<td><strong>Estructuras de control</strong></td>
<td><code>for (i in 1:10) {}</code></td>
<td><code>for (i in 1:10) {}</code></td>
</tr>
<tr class="even">
<td><strong>Funciones definidas</strong></td>
<td><code>function myFunc(x) { return(x^2) }</code></td>
<td><code>myFunc &lt;- function(x) { x^2 }</code></td>
</tr>
<tr class="odd">
<td><strong>Asignación de valores</strong></td>
<td><code>:=</code> para deterministas, <code>=</code> para constantes</td>
<td><code>&lt;-</code> para todo</td>
</tr>
<tr class="even">
<td><strong>Inferencia Bayesiana</strong></td>
<td>Integrada con <code>mcmc()</code></td>
<td>Necesita paquetes adicionales</td>
</tr>
</tbody>
</table>
</section>
<section id="ejemplo-micheladas-en-tepito" class="level1">
<h1>📊 Ejemplo Micheladas en Tepito</h1>
<p>Queremos estimar la probabilidad <strong>( p )</strong> de que un estudiante disfrute del ambiente en las <strong>micheladas en Tepito</strong>.</p>
<p>Hemos recopilado información de estudiantes que visitaron el lugar:</p>
<p>✔️ <strong>10 estudiantes fueron encuestados</strong><br>
✔️ <strong>7 estudiantes disfrutaron el ambiente</strong>, <strong>3 no lo disfrutaron</strong><br>
✔️ Queremos estimar la probabilidad de que <strong>tú</strong>, como nuevo visitante, disfrutes del ambiente.</p>
<hr>
<section id="definiendo-el-modelo-en-revbayes" class="level2">
<h2 class="anchored" data-anchor-id="definiendo-el-modelo-en-revbayes">🔹 1. Definiendo el Modelo en RevBayes</h2>
<section id="distribución-prior" class="level3">
<h3 class="anchored" data-anchor-id="distribución-prior">📌 <strong>Distribución Prior</strong></h3>
<p>Antes de ver los datos, asumimos una <strong>creencia previa</strong> sobre la probabilidad <strong>( p )</strong>.<br>
Utilizamos una <strong>distribución Beta(8,2)</strong>, basada en la suposición de que aproximadamente el <strong>80%</strong> de las personas disfrutarán del ambiente.</p>
<p><span class="math display">\[
p \sim \text{Beta}(8,2)
\]</span></p>
<p><a href="https://mikeryanmay.shinyapps.io/plotprior/">Página para visualizar las distribuciones para RevBayes</a>, pega el siguiente código en Rev code:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">~</span> <span class="fu">dnBeta</span>(<span class="dv">8</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>La media de esta distribución es:</p>
<p><span class="math display">\[
E[p] = \frac{\alpha}{\alpha + \beta} = \frac{8}{8+2} = 0.8
\]</span></p>
<hr>
</section>
<section id="verosimilitud-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="verosimilitud-likelihood">📌 <strong>Verosimilitud (Likelihood)</strong></h3>
<p>La verosimilitud describe la probabilidad de observar los datos dados un valor específico de <strong>( p )</strong>.<br>
Como cada estudiante puede estar <strong>satisfecho (éxito)</strong> o <strong>insatisfecho (fracaso)</strong>, usamos una <strong>distribución Binomial</strong>:</p>
<p><span class="math display">\[
k \sim \text{Binomial}(n = 10, p)
\]</span></p>
<p>Donde: - ( k = 7 ) es el número de estudiantes satisfechos observados. - ( n = 10 ) es el número total de encuestados.</p>
<hr>
</section>
<section id="posterior-bayesiana" class="level3">
<h3 class="anchored" data-anchor-id="posterior-bayesiana">📌 <strong>Posterior Bayesiana</strong></h3>
<p>Aplicamos el <strong>Teorema de Bayes</strong>:</p>
<p><span class="math display">\[
P(p | D) \propto P(D | p) P(p)
\]</span></p>
<p>Dado que usamos un <strong>prior Beta</strong> y una <strong>verosimilitud Binomial</strong>, la posterior también sigue una <strong>distribución Beta</strong> con parámetros actualizados:</p>
<p><span class="math display">\[
p | D \sim \text{Beta}(8+7, 2+3) = \text{Beta}(15,5)
\]</span></p>
<p>La <strong>media de la posterior</strong> nos da la mejor estimación después de observar los datos:</p>
<p><span class="math display">\[
E[p] = \frac{15}{15 + 5} = 0.75
\]</span></p>
<p>Esto significa que, <strong>después de observar que 7 de 10 estudiantes disfrutaron el ambiente</strong>, nuestra mejor estimación de la probabilidad de que tú disfrutes del ambiente es <strong>75%</strong>.</p>
<hr>
</section>
</section>
<section id="código-en-revbayes" class="level2">
<h2 class="anchored" data-anchor-id="código-en-revbayes">🔹 2. Código en RevBayes</h2>
<p>A continuación, presentamos el código en <strong>RevBayes</strong> para implementar este modelo y ejecutar un análisis MCMC.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/rebvayes/binomial_graphical_model.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Modelo Grafico" width="250"></p>
</figure>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># RevBayes - Algoritmo de Metropolis-Hastings para estimar</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># la probabilidad de disfrutar el ambiente en las micheladas de Tepito</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Datos observados</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>total_clientes <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># Número total de encuestados</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>satisfechos <span class="ot">&lt;-</span> <span class="dv">7</span>      <span class="co"># Número de estudiantes que disfrutaron el ambiente</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Especificar la distribución prior</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="dv">8</span>   <span class="co"># Basado en la creencia previa de 80% satisfacción</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>beta  <span class="ot">&lt;-</span> <span class="dv">2</span>   <span class="co"># Complemento del prior</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>p <span class="sc">~</span> <span class="fu">dnBeta</span>(alpha, beta)  <span class="co"># Prior Beta(8,2)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la propuesta de MCMC con Metropolis-Hastings</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>moves[<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mvSlide</span>(p, <span class="at">delta=</span><span class="fl">0.1</span>, <span class="at">weight=</span><span class="dv">1</span>)  <span class="co"># Movimiento en la distribución de p</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Especificar el modelo de verosimilitud (distribución Binomial)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>k <span class="sc">~</span> <span class="fu">dnBinomial</span>(p, total_clientes)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">k.clamp</span>(satisfechos)  <span class="co"># Fijar la observación de 7 estudiantes satisfechos</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear el modelo</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>my_model <span class="ot">=</span> <span class="fu">model</span>(p)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir monitores para el MCMC</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>monitors[<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mnModel</span>(<span class="at">filename=</span><span class="st">"micheladas_MH.log"</span>, <span class="at">printgen=</span><span class="dv">10</span>, <span class="at">separator =</span> TAB)  <span class="co"># Guardar resultados</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>monitors[<span class="dv">2</span>] <span class="ot">=</span> <span class="fu">mnScreen</span>(<span class="at">printgen=</span><span class="dv">100</span>, p)  <span class="co"># Mostrar progreso cada 100 generaciones</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear el análisis MCMC con Metropolis-Hastings</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>analysis <span class="ot">=</span> <span class="fu">mcmc</span>(my_model, monitors, moves)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar el MCMC con 100,000 iteraciones</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="fu">analysis.run</span>(<span class="dv">100000</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar el resumen de los operadores de MCMC</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="fu">analysis.operatorSummary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="mini-ejercicio" class="level2">
<h2 class="anchored" data-anchor-id="mini-ejercicio">Mini-ejercicio</h2>
<ol type="1">
<li><p><strong>Crea un script</strong> para RevBayes (<code>.Rev</code>) utilizando <code>Visual Studio Code</code> y copia el codigo.</p></li>
<li><p><strong>Modifica el prior</strong> <code>dnBeta(alpha, beta)</code> con los valores que reflejen tu creencia sobre la probabilidad de satisfacción.</p></li>
<li><p><strong>Guarda el archivo <code>micheladas_MH.log</code></strong> en la carpeta asiganada para guardar resultados.</p></li>
<li><p><strong>Guarda el script</strong> en la carpeta de <code>scripts</code>.</p></li>
<li><p><strong>Ejecuta el análisis</strong> MCMC en RevBayes.</p></li>
<li><p><strong>Visualiza los resultados</strong> usando <code>Tracer</code> para observar la distribución posterior.</p></li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/Rstudio.html" class="pagination-link" aria-label="Apuntes sobre R y Rstudio">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Apuntes sobre R y Rstudio</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/u1_intro_diversification.html" class="pagination-link" aria-label="Introducción al proceso de diversificación">
        <span class="nav-page-text"><span class="chapter-title">Introducción al proceso de diversificación</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>