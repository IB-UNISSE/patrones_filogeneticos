---
title: "Biogeograf√≠a Bayesiana de Islas (BIB)"
format: html
execute:
  echo: true   # Muestra el c√≥digo
  warning: false  # Oculta advertencias
  fig-width: 12   # Ancho del gr√°fico
  fig-height: 8   # Altura del gr√°fico
---

## **Introducci√≥n**

En esta pr√°ctica, realizaremos un **an√°lisis biogeogr√°fico bayesiano** en **RevBayes** utilizando el **modelo BIB**, aplicado a un **conjunto de datos emp√≠ricos** compuesto por varios clados distribuidos en un **mismo conjunto de √°reas geogr√°ficas**.

Como hemos aprendido en las clases, el modelo BIB incluye solo **dos componentes principales**:

-   Las **√°reas discretas codificadas por presencia/ausencia**, que representan la distribuci√≥n geogr√°fica de los taxones.

-   El **componente anagen√©tico**, descrito por la **matriz Q**, que modela las tasas de dispersi√≥n o migraci√≥n entre √°reas.

Es importante destacar que el modelo BIB **no incluye un componente cladogen√©tico**, es decir, **no modela expl√≠citamente escenarios de herencia de rangos durante los eventos de especiaci√≥n**.

El objetivo principal de este an√°lisis es estimar **patrones comunes en la evoluci√≥n de los rangos geogr√°ficos**. En particular, buscamos responder la siguiente pregunta:

*¬øPodemos inferir reglas generales sobre las tasas de dispersi√≥n entre √°reas estimando dichas tasas en m√∫ltiples clados que comparten un mismo contexto biogeogr√°fico?*

## Grupo de estudio

Trabajaremos con un conjunto de **nueve clados** distribuidos en las **Islas Canarias**, un archipi√©lago volc√°nico situado en el **oc√©ano Atl√°ntico**, cerca del noroeste de √Åfrica.

Estos clados (g√©neros, tribus o ‚Äúalianzas gen√©ricas‚Äù) **var√≠an en el n√∫mero de especies** y **pertenecen a distintos grupos taxon√≥micos**, como insectos, angiospermas y mil√≠pedos. Adem√°s, presentan **diferentes preferencias ecol√≥gicas**. A pesar de estas diferencias, **comparten una historia biogeogr√°fica com√∫n**, ya que todos ellos est√°n distribuidos‚Äîaunque no necesariamente de manera id√©ntica‚Äî**en el mismo conjunto de islas**.

Las **Islas Canarias** se formaron como resultado del **desplazamiento de la placa africana sobre un ‚Äúpunto caliente‚Äù**, una fuente persistente de magma localizada en el oc√©ano Atl√°ntico. A diferencia de otros archipi√©lagos volc√°nicos formados por puntos calientes, como **Haw√°i**, la historia volc√°nica de las Canarias tambi√©n estuvo influida por procesos **tect√≥nicos continentales**, en particular por una fractura que se propag√≥ desde la **cordillera del Atlas africano**.

Todas las islas emergieron durante los **√∫ltimos 20 millones de a√±os**. Las islas orientales, como **Lanzarote y Fuerteventura**, son las m√°s antiguas, mientras que las islas m√°s occidentales, como **La Palma y El Hierro**, son las m√°s recientes.

![](/images/u2_PatBio/Figure1.png){fig-align="center" width="600"}

> Esta pr√°ctica se basa en la informaci√≥n presentada en: Sanmart√≠n, I., Van Der Mark, P., & Ronquist, F. (2008). Inferring dispersal: A Bayesian approach to phylogeny‚Äêbased island biogeography, with special reference to the Canary Islands. *Journal of Biogeography*, 35(3), 428‚Äì449. https://doi.org/10.1111/j.1365-2699.2008.01885.x

## Descarga los conjuntos de datos

Revisa el contenido de cada uno de estos archivos. Notar√°s que, a diferencia del modelo **DEC**, el modelo **BIB trabaja directamente con alineamientos de secuencias de ADN**. Esto significa que en este an√°lisis vamos a **inferir simult√°neamente** la **filogenia** (las relaciones evolutivas entre especies) y los **patrones y tasas de evoluci√≥n de los rangos geogr√°ficos**.

<a href="../docs/u2_PatBio/BIB/Bystropogon.nex" download>üåø Bystropogon</a>

<a href="../docs/u2_PatBio/BIB/Calathus.nex" download>ü™≤ Calathus</a>

<a href="../docs/u2_PatBio/BIB/Dolichoiulus.nex" download>üêõ Dolichoiulus</a>

<a href="../docs/u2_PatBio/BIB/Lotus.nex" download>üå∏ Lotus</a>

<a href="../docs/u2_PatBio/BIB/Micromeria.nex" download>üå∫ Micromeria</a>

<a href="../docs/u2_PatBio/BIB/Pimelia.nex" download>üêû Pimelia</a>

<a href="../docs/u2_PatBio/BIB/Psyllids.nex" download>ü™∞ Psyllids</a>

Cada archivo `.nex` contiene **dos matrices**:

1.  La **primera matriz** incluye el **alineamiento de secuencias de ADN**, donde los estados de car√°cter son los nucle√≥tidos (por ejemplo: A, C, T, G).

2.  La **segunda matriz** contiene los **estados biogeogr√°ficos**, codificados en una sola columna. Cada fila representa una especie (o un voucher de secuencia de ADN) y se codifica seg√∫n su distribuci√≥n geogr√°fica.

## Codificaci√≥n de √°reas

La codificaci√≥n de √°reas sigue el esquema propuesto por **Sanmart√≠n et al. (2008)**, el cual divide las Islas Canarias en **tres grupos geol√≥gicos** de islas. Esta clasificaci√≥n se basa en las **pulsaciones geol√≥gicas** que dieron origen a las islas a lo largo de los √∫ltimos **20 millones de a√±os**:

-   **Islas Orientales (1):** Lanzarote (15 Ma) y Fuerteventura (20 Ma)

-   **Islas Centrales (2):** Gran Canaria (14 Ma), Tenerife (12 Ma) y La Gomera (10 Ma)

-   **Islas Occidentales (3):** La Palma (2 Ma) y El Hierro (0.8 Ma)

Adem√°s, consideramos un **cuarto estado** para representar la **zona continental**, que puede actuar como fuente o destino de dispersi√≥n:

-   **Continente (0):** incluye la Pen√≠nsula Ib√©rica, otros archipi√©lagos macaron√©sicos y el continente africano.

## Modelos bayesianos de islas

Cada **c√≠rculo** representa una isla; el **tama√±o del c√≠rculo** indica su **capacidad de carga relativa** (es decir, el n√∫mero esperado de linajes en equilibrio); el **grosor de las flechas** representa la **tasa relativa de dispersi√≥n** entre pares de islas.

![](/images/u2_PatBio/u2_PatBio_2.png){fig-align="center" width="500"}

Se muestran seis variantes del modelo:

-   **(a) Modelo Jukes‚ÄìCantor (JC):** todas las islas tienen igual capacidad de carga y todas las tasas de dispersi√≥n son iguales.

-   **(b) Modelo Equal-in:** las capacidades de carga son desiguales, pero las tasas de dispersi√≥n siguen siendo iguales.

-   **(c) Modelo GTR (General Time Reversible):** tanto las capacidades de carga como las tasas de dispersi√≥n son desiguales.

-   **(d) Variante Stepping-stone del modelo JC (JC step):** todas las islas tienen igual capacidad de carga, las tasas de dispersi√≥n son iguales pero **solo entre islas adyacentes**, siendo cero entre islas no adyacentes.

-   **(e) Equal-in step:** capacidades de carga desiguales, tasas de dispersi√≥n iguales entre islas adyacentes, cero entre islas no adyacentes.

-   **(f) GTR step:** capacidades de carga desiguales y tasas de dispersi√≥n tambi√©n desiguales entre islas adyacentes, cero entre islas no adyacentes.

## Construcci√≥n de un an√°lisis BIB utilizando el modelo GTR

En este paso, construimos el modelo molecular para cada clado de forma independiente utilizando un bucle. Cada grupo (o partici√≥n) de datos tiene su propia filogenia, tasa de sustituci√≥n, par√°metros evolutivos y distribuci√≥n de tasas entre sitios.

**¬øQu√© es la distribuci√≥n Dirichlet?**

La **distribuci√≥n Dirichlet** es una distribuci√≥n de probabilidad para **proporciones** que deben **sumar 1**. Es decir, si tienes varios eventos (como frecuencias de nucle√≥tidos o tasas de sustituci√≥n), y cada uno tiene un valor entre 0 y 1, la Dirichlet te da una forma de **asignar probabilidades a todas las combinaciones posibles** de esos valores **respetando que sumen 1**.

Piensa en ella como una **generalizaci√≥n de la distribuci√≥n Beta**, que solo se aplica a dos proporciones (por ejemplo, √©xito y fracaso).

![](https://revbayes.github.io/tutorials/ctmc/figures/dirichlet_rates.png){fig-align="center" width="600"}

**Script del modelo molecular**

Crea un archivo llamado `**bib_molecular.Rev**`.

Este script contiene la definici√≥n del **modelo molecular independiente para cada clado**, incluyendo la matriz de sustituci√≥n, la tasa de reloj, el modelo de √°rbol (birth-death), la heterogeneidad entre sitios, y los movimientos (moves) correspondientes.

``` r
# Este archivo procesa todos los conjuntos de datos de manera conjunta. 
# Asumimos que cada grupo tiene su propio modelo molecular, pero comparten el modelo biogeogr√°fico.

# Asumimos que todos los datos moleculares y biogeogr√°ficos est√°n contenidos 
# en un solo archivo por cada g√©nero. Los datos moleculares deben estar en 
# la primera matriz de datos en cada archivo, y los datos biogeogr√°ficos en 
# la segunda matriz. Los estados biogeogr√°ficos deben ser los mismos entre grupos.

# Leer todas las matrices de datos moleculares en el vector D
# Leer todas las matrices de datos biogeogr√°ficos en el vector B
# Tambi√©n se definen las calibraciones de edad para cada grupo

filenames <- [  "../data/BIB/Bystropogon.nex",
                "../data/BIB/Calathus.nex",
                "../data/BIB/Dolichoiulus.nex",
                "../data/BIB/Micromeria.nex",
                "../data/BIB/Lotus.nex",
                "../data/BIB/Pimelia.nex",
                "../data/BIB/Psyllids.nex"
              ]

# Bucle para leer cada archivo y separar sus dos matrices de datos
for ( i in 1:filenames.size() ){
    X <- readDiscreteCharacterData( filenames[i] )

    D[i] <- X[1]  # Primer bloque: datos moleculares
    B[i] <- X[2]  # Segundo bloque: datos biogeogr√°ficos
}

# Crear el vector de movimientos para el MCMC
moves = VectorMoves()

# Definir el modelo molecular para cada grupo
for ( i in 1:D.size() ) {

    # Definir priors para los elementos de la matriz de tasas de sustituci√≥n
    pi_M[i] ~ dnDirichlet( v(1,1,1,1) )             # Frecuencias de equilibrio de nucle√≥tidos
    r_M[i]  ~ dnDirichlet( v(1,1,1,1,1,1) )         # Tasas de intercambio entre pares de nucle√≥tidos

    # Definir la matriz de sustituci√≥n Q (nodo determinista)
    Q_M[i] := fnGTR( r_M[i], pi_M[i] )

    # Tasa de reloj molecular: prior exponencial con esperanza de 0.001
    # porque los datos son de cloroplastos, t√≠picamente entre 1E-4 y 1E-3
    clockRate_M[i] ~ dnExponential( 1000.0 ) 

    # Definir par√°metros previos del modelo de √°rbol (Birth-Death)

    # Prior para la tasa de diversificaci√≥n
    # El valor esperado representa ~20 linajes en 3 millones de a√±os (T = 3, r = 1)
    diversification[i] ~ dnExponential( 1.0 )

    # Prior no informativo para el turnover (extinci√≥n/especiaci√≥n)
    turnover[i] ~ dnUniform(0.000001, 0.999999)

    # Conversi√≥n a par√°metros subyacentes: lambda = especiaci√≥n, mu = extinci√≥n
    lambda[i] := diversification[i] / abs(1.0 - turnover[i])
    mu[i]     := turnover[i] * lambda[i]

    # Prior para la edad de la ra√≠z: entre 0 y 20 millones de a√±os
    # Edad geol√≥gica del archipi√©lago canario (de El Hierro a Fuerteventura)
    rootAge[i] ~ dnUniform( 0.000001, 20.0 )

    # Definir el modelo completo del √°rbol filogen√©tico para el grupo i
    tau[i] ~ dnBirthDeath(
        lambda = lambda[i],
        mu = mu[i],
        rootAge = rootAge[i],
        rho = 1.0,
        samplingStrategy = "uniform",
        condition = "time",
        taxa = D[i].taxa()
    )

    # Prior para la heterogeneidad entre sitios (distribuci√≥n gamma)
    alpha_M[i] ~ dnExponential(1.0)

    # Cuatro cuantiles para la gamma discretizada
    probs <- v( 0.125, 0.375, 0.625, 0.875 )

    # Inicializar el vector de tasas por sitio
    siteRates_M[i] <- rep(0.0, 4)

    # Llenar el vector con tasas extra√≠das de una distribuci√≥n gamma
    for ( j in 1:4 ) {
        siteRates_M[i][j] := qgamma( probs[j], alpha_M[i], alpha_M[i] )
    }

    # Definir el modelo completo de evoluci√≥n de secuencias de ADN
    seq_M[i] ~ dnPhyloCTMC(
        tree        = tau[i],
        Q           = Q_M[i],
        branchRates = clockRate_M[i],
        siteRates   = siteRates_M[i],
        nSites      = D[i].nchar(),
        type        = "DNA"
    )

    # Fijar (clamp) el modelo a los datos observados
    seq_M[i].clamp( D[i] )

    # A√±adir movimientos MCMC para explorar el espacio de par√°metros
    moves.append(mvScale(clockRate_M[i], lambda=1, tune=true, weight=1))
    moves.append(mvScale(rootAge[i], lambda=1, tune=true, weight=1))
    moves.append(mvScale(diversification[i], lambda=1, tune=true, weight=1))
    moves.append(mvScale(turnover[i], lambda=1, tune=true, weight=1))
    moves.append(mvNNI(tau[i], weight=10.0))                     # Reordenamiento de nodos internos
    moves.append(mvFNPR(tau[i], weight=10.0))                    # Movimiento topol√≥gico
    moves.append(mvSubtreeScale(tau[i], weight=5.0))             # Escalado de sub√°rbol
    moves.append(mvNodeTimeSlideUniform(tau[i], weight=10.0))    # Movimiento en tiempos de nodos
    moves.append(mvScale(alpha_M[i], lambda=1, tune=true, weight=1.0))  # Movimiento para alpha
}
```

**Script del modelo biogeogr√°fico**

Crea un segundo archivo llamado `**bib_biogeo.Rev**`.

Este script carga el modelo molecular desde `bib_molecular.Rev` y define el **modelo biogeogr√°fico compartido** entre todos los clados. Aqu√≠ se construye la matriz GTR biogeogr√°fica (`Q_bio`), las capacidades de carga, las tasas de dispersi√≥n por clado, y se ejecuta la inferencia bayesiana.

``` r
# Definici√≥n del modelo biogeogr√°fico BIB compartido por todos los clados

source("bib_molecular.Rev")  # Este script es el que contiene el modelo molecular definido previamente

# Asumimos los siguientes c√≥digos de estados (indexados desde 0 en el archivo Nexus, desde 1 aqu√≠):
# 0 ‚Üí 1 Eastern Islands (Fuerteventura, Lanzarote)
# 1 ‚Üí 2 Central Islands (Tenerife, Gran Canaria, La Gomera)
# 2 ‚Üí 3 Western Islands  (El Hierro, La Palma)
# 3 ‚Üí 4 Mainland (Pen√≠nsula Ib√©rica, √Åfrica, otras islas macaron√©sicas)

# Definir las capacidades de carga de las islas (œÄ) y las tasas de dispersion (r)
pi_bio ~ dnDirichlet( v(1,1,1,1) )               # Prior Dirichlet plano para las frecuencias de √°rea
r_bio  ~ dnDirichlet( v(1,1,1,1,1,1) )           # Prior Dirichlet plano para las tasas de dispersi√≥n

# Definir la matriz de tasas biogeogr√°ficas Q usando un modelo GTR
Q_bio := fnGTR( r_bio, pi_bio )

# La tasa de dispersion se define en unidades de tiempo;
# el prior se basa en asumir una tasa esperada de 1.0 eventos de dispersi√≥n por mill√≥n de a√±os.
# Se quiere un prior relativamente vago, dada la incertidumbre.
# Usamos una distribuci√≥n gamma(1,1), equivalente a una exponencial(1).
# El intervalo de credibilidad del 50% es (0.29, 1.39) y el del 95% es (0.025, 3.69)

moves = VectorMoves()           # Crear vector de movimientos
monitors = VectorMonitors()     # Crear vector de monitores

# Bucle para aplicar el modelo biogeogr√°fico a cada clado
for ( i in 1:B.size() ) {

    migrationRates[i] ~ dnGamma( 1.0, 1.0 )  # Prior para la tasa de dispersi√≥n por clado

    # Definir el modelo de biogeograf√≠a para el clado i
    # Asume que los √°rboles tau est√°n en unidades de tiempo
    bio[i] ~ dnPhyloCTMC(
        tree            = tau[i],
        Q               = Q_bio,
        rootFrequencies = pi_bio,
        branchRates     = migrationRates[i],
        nSites          = 1,
        type            = "Standard"
    )

    bio[i].clamp( B[i] )  # Anclar el modelo a los datos biogeogr√°ficos observados

    # Construir el modelo completo (s√≥lo se requiere uno porque todos comparten Q_bio)
    mymodel = model( bio[1] )

    # Agregar movimientos para los par√°metros biogeogr√°ficos (œÄ, r y tasa de dispersi√≥n)
    # Asumimos que los movimientos del modelo molecular ya est√°n definidos
    moves.append(mvSimplexElementScale(pi_bio, alpha=10.0, tune=true, weight=4.0))
    moves.append(mvSimplexElementScale(r_bio, alpha=10.0, tune=true, weight=6.0))
    moves.append(mvScale(migrationRates[i], lambda=1, tune=true, weight=1))
}

# Definir el nombre base para los archivos de salida
runName <- "biogeo_model"

# Definir monitores de salida para el modelo y para la pantalla

# Monitor que guarda los par√°metros en archivo .csv
monitors.append(
    mnModel(
        filename = "../output/BIB/" + runName + ".csv",
        printgen = 10
    )
)

# Monitor que imprime en pantalla el valor de r_bio cada 100 generaciones
monitors.append(
    mnScreen(
        printgen = 100,
        r_bio
    )
)

# Ejecutar el MCMC
mymcmc = mcmc( mymodel, monitors, moves )
mymcmc.run(generations=5000)
```

‚ñ∂Ô∏è Ejecuci√≥n del an√°lisis Una vez que hayas creado y guardado los scripts **bib_molecular.Rev** y **bib_biogeo.Rev**, puedes ejecutar el an√°lisis completo desde la terminal utilizando el comando:

``` r
rb bib_biogeo.Rev
```

### üìä Inspecci√≥n de los resultados en **Tracer**

Al finalizar la ejecuci√≥n del an√°lisis, se generar√° un archivo `.csv` en la carpeta `output/BIB/` con los resultados del modelo (`biogeo_model.csv`).

Este archivo debe abrirse en el programa **Tracer** para visualizar los par√°metros estimados y evaluar su convergencia y distribuci√≥n posterior.

Entre los par√°metros que podr√°s observar en Tracer est√°n:

-   `pi_bio[1]` a `pi_bio[4]`: las **capacidades de carga** estimadas para cada √°rea.

-   `r_bio[1]` a `r_bio[6]`: las **tasas de dispersi√≥n relativas** entre pares de √°reas (modelo GTR).

-   `migrationRates[i]`: la tasa de dispersi√≥n estimada para cada clado.

### üîé Ejemplo: interpretaci√≥n de `r_bio` seg√∫n la tasa de sustituci√≥n nucleot√≠dica

Recuerda que los par√°metros en una distribuci√≥n **Dirichlet** usada en modelos tipo GTR siguen un **orden predefinido**.\

Esto aplica tanto para modelos de sustituci√≥n nucleot√≠dica como para modelos de dispersi√≥n entre √°reas.

Por ejemplo, en un modelo GTR de **sustituci√≥n de nucle√≥tidos**, los par√°metros `r` se interpretan as√≠:

1.  `r[1]` = A ‚ü∑ C

2.  `r[2]` = A ‚ü∑ G

3.  `r[3]` = A ‚ü∑ T

4.  `r[4]` = C ‚ü∑ G

5.  `r[5]` = C ‚ü∑ T

6.  `r[6]` = G ‚ü∑ T

De manera an√°loga, en el modelo BIB los par√°metros `r_bio[1]` a `r_bio[6]` representan las **tasas de dispersi√≥n entre pares de √°reas**, en un orden similar.

Aunque aqu√≠ no representen nucle√≥tidos, la posici√≥n de cada par√°metro en `r_bio` sigue el mismo esquema de codificaci√≥n, por lo que es importante tenerlo en cuenta al interpretar los resultados.
